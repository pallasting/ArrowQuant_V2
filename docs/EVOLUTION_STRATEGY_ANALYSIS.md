# æ¼”è¿›è·¯å¾„å¯¹æ¯”åˆ†æï¼šC â†’ D vs C+D

**åˆ†ææ—¥æœŸ**: 2026-02-17
**åˆ†æç›®çš„**: è¯„ä¼°æ¸è¿›å¼æ¼”è¿› vs ä¸€æ­¥åˆ°ä½çš„å¤æ‚åº¦å’Œé£é™©

---

## æ‰§è¡Œæ‘˜è¦

**æ¨èæ–¹æ¡ˆ**: âœ… **å…ˆ C å Dï¼ˆæ¸è¿›å¼æ¼”è¿›ï¼‰**

**æ ¸å¿ƒç†ç”±**:
- ğŸ“‰ **å¤æ‚åº¦æ›´ä½** - åˆ†é˜¶æ®µé™ä½è®¤çŸ¥è´Ÿæ‹…
- ğŸ›¡ï¸ **é£é™©å¯æ§** - æ¯ä¸ªé˜¶æ®µå¯ç‹¬ç«‹éªŒè¯
- ğŸ’° **æˆæœ¬æ›´ä½** - é¿å…è¿‡åº¦è®¾è®¡ï¼ŒæŒ‰éœ€æŠ•å…¥
- ğŸ”„ **æ¶æ„å…¼å®¹** - C å’Œ D æ•°æ®ç»“æ„å®Œå…¨å…¼å®¹ï¼Œ**é›¶è¿ç§»æˆæœ¬**

---

## æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1: å…ˆ C å Dï¼ˆæ¸è¿›å¼æ¼”è¿›ï¼‰

```
é˜¶æ®µ 1 (Week 1-6): ç­–ç•¥ C - è¯­ä¹‰ç´¢å¼•
  â†“
éªŒè¯ã€ä¼˜åŒ–ã€ç¨³å®šè¿è¡Œ
  â†“
é˜¶æ®µ 2 (è§¦å‘æ¡ä»¶æ»¡è¶³æ—¶): å¢åŠ ç­–ç•¥ D - æ™ºèƒ½åˆ†æµ
```

### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½

```
Week 1-10: åŒæ—¶å®ç°ç­–ç•¥ C + ç­–ç•¥ D
```

---

## è¯¦ç»†å¯¹æ¯”åˆ†æ

### 1. å¼€å‘å¤æ‚åº¦

#### æ–¹æ¡ˆ 1: å…ˆ C å D (æ¸è¿›å¼)

**é˜¶æ®µ 1 - ç­–ç•¥ C (Week 1-6)**:
```python
class MemoryStore:
    """ç®€å•ã€ä¸“æ³¨çš„å®ç°"""

    def store(self, text: str) -> str:
        # 1. Arrow å‹ç¼©ï¼ˆç»Ÿä¸€è·¯å¾„ï¼‰
        compressed = arrow_compress(text)

        # 2. åŠ å…¥ç´¢å¼•é˜Ÿåˆ—ï¼ˆç»Ÿä¸€è·¯å¾„ï¼‰
        index_queue.add(text)

        # 3. è¿”å›
        return memory_id

    @background_task
    def batch_index(self):
        # æ‰¹é‡è¯­ä¹‰ç´¢å¼•ï¼ˆç»Ÿä¸€é€»è¾‘ï¼‰
        batch = queue.get_batch()
        indices = llm_batch_extract(batch)
        storage.update_indices(indices)
```

**ä»£ç é‡**: ~800 LOC
**æµ‹è¯•ç”¨ä¾‹**: ~50 ä¸ª
**æ ¸å¿ƒé€»è¾‘**: 2 æ¡è·¯å¾„ï¼ˆå­˜å‚¨ã€æ£€ç´¢ï¼‰

---

**é˜¶æ®µ 2 - å¢åŠ ç­–ç•¥ D (Later)**:

**å…³é”®æ´å¯Ÿ**: æ•°æ®ç»“æ„å®Œå…¨å…¼å®¹ï¼

```python
@dataclass
class StoredMemory:
    """å·²æœ‰çš„æ•°æ®ç»“æ„ï¼ˆC é˜¶æ®µï¼‰"""
    id: str
    original_compressed: bytes  # Arrow å‹ç¼©
    semantic_index: Optional[SemanticIndex]
    metadata: dict  # â† å…³é”®ï¼šå·²é¢„ç•™æ‰©å±•å­—æ®µ

# å¢åŠ  D ç­–ç•¥æ—¶ï¼Œåªéœ€æ‰©å±• metadata
metadata = {
    "compression_strategy": "arrow_only",  # æ–°å¢
    "skip_llm_indexing": True,            # æ–°å¢
    "text_length": 50,                    # æ–°å¢
    # å…¶ä»–å­—æ®µä¿æŒä¸å˜
}
```

**æ–°å¢ä»£ç **:
```python
class SmartRouter:
    """æ™ºèƒ½è·¯ç”±å™¨ï¼ˆæ–°å¢æ¨¡å—ï¼‰"""

    def select_strategy(self, text: str, metadata: dict) -> str:
        # å†³ç­–é€»è¾‘
        if len(text) < 100:
            return "arrow_only"
        elif self.find_duplicate(text):
            return "reference"
        elif len(text) > 1000:
            return "llm_realtime"
        else:
            return "semantic_index"  # â† å¤ç”¨ç­–ç•¥ C

    def store_with_routing(self, text: str) -> str:
        strategy = self.select_strategy(text)

        if strategy == "arrow_only":
            return self.store_arrow_only(text)
        elif strategy == "semantic_index":
            return self.existing_store(text)  # â† ç›´æ¥å¤ç”¨
        # ... å…¶ä»–ç­–ç•¥
```

**æ–°å¢ä»£ç é‡**: ~400 LOC (å¤ç”¨ C çš„ 80%)
**æ–°å¢æµ‹è¯•**: ~30 ä¸ª
**æ•°æ®è¿ç§»**: **é›¶** (metadata æ‰©å±•ï¼Œå‘åå…¼å®¹)

**æ€»å¤æ‚åº¦**: 800 + 400 = 1,200 LOC

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½

**ä¸€æ¬¡æ€§å®ç°**:
```python
class MemoryStore:
    """å¤æ‚çš„å¤šè·¯å¾„å®ç°"""

    def store(self, text: str, metadata: dict) -> str:
        # å†³ç­–æ ‘ï¼ˆç¬¬ä¸€å¤©å°±è¦è€ƒè™‘ï¼‰
        strategy = self.router.select_strategy(text, metadata)

        if strategy == "arrow_only":
            return self._store_arrow_only(text)

        elif strategy == "semantic_index":
            return self._store_semantic_index(text)

        elif strategy == "llm_realtime":
            return self._store_llm_realtime(text)

        elif strategy == "reference":
            return self._store_reference(text)

        # ... æ›´å¤šç­–ç•¥

    def search(self, query: str) -> List[Memory]:
        # éœ€è¦å¤„ç†å¤šç§æ•°æ®æ ¼å¼
        results = []

        # è·¯å¾„ 1: è¯­ä¹‰ç´¢å¼•
        semantic_results = self._search_semantic(query)
        results.extend(semantic_results)

        # è·¯å¾„ 2: Arrow onlyï¼ˆéœ€è¦å…¨æ–‡æ£€ç´¢ï¼‰
        arrow_results = self._search_arrow_only(query)
        results.extend(arrow_results)

        # è·¯å¾„ 3: å¼•ç”¨ï¼ˆéœ€è¦è§£æå¼•ç”¨é“¾ï¼‰
        ref_results = self._search_references(query)
        results.extend(ref_results)

        # åˆå¹¶ã€å»é‡ã€æ’åº
        return self._merge_and_rank(results)
```

**ä»£ç é‡**: ~1,500 LOC (ä¸€æ¬¡æ€§)
**æµ‹è¯•ç”¨ä¾‹**: ~100 ä¸ª (éœ€è¦æµ‹è¯•æ‰€æœ‰ç»„åˆ)
**æ ¸å¿ƒé€»è¾‘**: 4+ æ¡è·¯å¾„ï¼ˆå­˜å‚¨ã€æ£€ç´¢éƒ½æœ‰å¤šåˆ†æ”¯ï¼‰

**é—®é¢˜**:
- âŒ **è®¤çŸ¥è´Ÿæ‹…é«˜** - ç¬¬ä¸€å¤©å°±è¦ç†è§£æ‰€æœ‰ç­–ç•¥
- âŒ **æµ‹è¯•å¤æ‚** - ç­–ç•¥ç»„åˆçˆ†ç‚¸ï¼ˆ4Ã—4=16 ç§åœºæ™¯ï¼‰
- âŒ **è°ƒè¯•å›°éš¾** - ä¸çŸ¥é“å“ªä¸ªç­–ç•¥å‡ºäº†é—®é¢˜
- âŒ **è¿‡åº¦è®¾è®¡** - å¯èƒ½æœ‰äº›ç­–ç•¥æ ¹æœ¬ç”¨ä¸ä¸Š

**æ€»å¤æ‚åº¦**: 1,500 LOC (ä½†éš¾åº¦ 2x)

---

### 2. æ•°æ®è¿ç§»æˆæœ¬

#### æ–¹æ¡ˆ 1: å…ˆ C å D âœ… **é›¶è¿ç§»æˆæœ¬**

**ä¸ºä»€ä¹ˆé›¶è¿ç§»ï¼Ÿ**

**C é˜¶æ®µçš„æ•°æ®ç»“æ„**:
```python
@dataclass
class StoredMemory:
    id: str
    original_compressed: bytes  # Arrow format
    semantic_index: Optional[SemanticIndex]
    embedding: np.ndarray
    metadata: dict  # â† å…³é”®ï¼šçµæ´»çš„å…ƒæ•°æ®å­—æ®µ
```

**D é˜¶æ®µåªéœ€æ‰©å±• metadata**:
```python
# æ—§æ•°æ®ï¼ˆC é˜¶æ®µï¼‰
{
    "id": "mem_123",
    "metadata": {
        "source": "chat",
        "timestamp": "2026-02-17"
    }
}

# æ–°æ•°æ®ï¼ˆD é˜¶æ®µï¼‰- å‘åå…¼å®¹
{
    "id": "mem_456",
    "metadata": {
        "source": "chat",
        "timestamp": "2026-02-17",
        "compression_strategy": "arrow_only",  # æ–°å¢
        "skip_llm": True                       # æ–°å¢
    }
}

# è¯»å–æ—¶è‡ªåŠ¨å…¼å®¹
strategy = metadata.get("compression_strategy", "semantic_index")  # é»˜è®¤ç­–ç•¥ C
```

**è¿ç§»è„šæœ¬**: ä¸éœ€è¦ï¼æ—§æ•°æ®è‡ªåŠ¨è¢«è§†ä¸º"semantic_index"ç­–ç•¥

**éªŒè¯**:
```python
def test_backward_compatibility():
    # C é˜¶æ®µå­˜å‚¨çš„æ•°æ®
    old_memory = load_from_storage("mem_old")

    # D é˜¶æ®µä»£ç è¯»å–
    strategy = get_strategy(old_memory)
    assert strategy == "semantic_index"  # é»˜è®¤

    # æ­£å¸¸æ£€ç´¢
    results = search("test query")
    assert "mem_old" in [r.id for r in results]  # âœ… å¯ä»¥æ£€ç´¢åˆ°
```

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½ âš ï¸ **å¯èƒ½æœ‰è¿ç§»æˆæœ¬**

**é—®é¢˜**: å¦‚æœåœ¨å¼€å‘è¿‡ç¨‹ä¸­å‘ç°è®¾è®¡é—®é¢˜...

**åœºæ™¯ 1: æ•°æ®æ ¼å¼å˜æ›´**
```
Week 3: "æˆ‘ä»¬å‘ç°ç­–ç•¥æ ‡è¯†éœ€è¦æ›´å¤æ‚çš„ç»“æ„"
Week 4: éœ€è¦é‡æ–°è®¾è®¡æ•°æ®æ ¼å¼
Week 5: è¿ç§»å·²æœ‰çš„æµ‹è¯•æ•°æ®
```

**åœºæ™¯ 2: ç­–ç•¥è°ƒæ•´**
```
Week 6: "å‘ç° arrow_only ç­–ç•¥åˆ¤æ–­æ¡ä»¶ä¸å¯¹"
Week 7: éœ€è¦é‡æ–°åˆ†ç±»å·²å­˜å‚¨çš„ 1000 æ¡è®°å¿†
```

**è¿ç§»æˆæœ¬**: æ—¶é—´ + é£é™©

---

### 3. æµ‹è¯•å¤æ‚åº¦

#### æ–¹æ¡ˆ 1: å…ˆ C å D

**é˜¶æ®µ 1 æµ‹è¯•ï¼ˆCï¼‰**:
```python
# ç®€å•ã€ç›´æ¥çš„æµ‹è¯•
def test_store_and_retrieve():
    # å­˜å‚¨
    id = store("test text")

    # æ£€ç´¢
    results = search("test")
    assert id in results

# çº¦ 50 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–æ ¸å¿ƒåœºæ™¯
```

**é˜¶æ®µ 2 æµ‹è¯•ï¼ˆå¢åŠ  Dï¼‰**:
```python
# æ–°å¢è·¯ç”±æµ‹è¯•
def test_short_text_routing():
    id = store("Hi", metadata={"source": "chat"})
    memory = load(id)
    assert memory.metadata["strategy"] == "arrow_only"

def test_fallback_to_semantic():
    id = store("Medium length text...", metadata={})
    memory = load(id)
    assert memory.metadata["strategy"] == "semantic_index"

# æ–°å¢çº¦ 30 ä¸ªæµ‹è¯•ï¼Œä½†å¯ä»¥å¤ç”¨ C çš„ 50 ä¸ªæµ‹è¯•
# æ€»è®¡: 80 ä¸ªæµ‹è¯•
```

**ä¼˜åŠ¿**:
- âœ… **åˆ†é˜¶æ®µéªŒè¯** - æ¯ä¸ªé˜¶æ®µç‹¬ç«‹å¯æµ‹
- âœ… **å¤ç”¨æµ‹è¯•** - C çš„æµ‹è¯•åœ¨ D é˜¶æ®µä»ç„¶æœ‰æ•ˆ
- âœ… **æ¸è¿›è¦†ç›–** - æµ‹è¯•è¦†ç›–ç‡ç¨³æ­¥æå‡

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½

**ä¸€æ¬¡æ€§æµ‹è¯•æ‰€æœ‰ç»„åˆ**:
```python
# æµ‹è¯•çŸ©é˜µçˆ†ç‚¸
å­˜å‚¨ç­–ç•¥: [arrow_only, semantic_index, llm_realtime, reference]
æ£€ç´¢åœºæ™¯: [exact_match, semantic_search, hybrid]
æ•°æ®çŠ¶æ€: [indexed, pending_index, no_index, reference]

æ€»æµ‹è¯•åœºæ™¯: 4 Ã— 3 Ã— 4 = 48 ç§ç»„åˆ
```

**æ¯ä¸ªç»„åˆéœ€è¦æµ‹è¯•**:
```python
def test_arrow_only_exact_match_no_index():
    ...

def test_arrow_only_semantic_search_no_index():
    ...

def test_semantic_index_exact_match_indexed():
    ...

# ... 48 ä¸ªæµ‹è¯•å‡½æ•°
```

**é—®é¢˜**:
- âŒ **æµ‹è¯•ç”¨ä¾‹çˆ†ç‚¸** - 100+ æµ‹è¯•ç”¨ä¾‹
- âŒ **éš¾ä»¥å®šä½é—®é¢˜** - å“ªä¸ªç»„åˆå¤±è´¥äº†ï¼Ÿ
- âŒ **ç»´æŠ¤æˆæœ¬é«˜** - æ”¹ä¸€ä¸ªç­–ç•¥ï¼Œå½±å“å¤šä¸ªæµ‹è¯•

---

### 4. é£é™©åˆ†æ

#### æ–¹æ¡ˆ 1: å…ˆ C å D âœ… **ä½é£é™©**

**é£é™©éš”ç¦»**:

**é˜¶æ®µ 1 é£é™©ï¼ˆCï¼‰**:
- âš ï¸ è¯­ä¹‰ç´¢å¼•è´¨é‡ä¸ä½³ â†’ å¯ä»¥ä¼˜åŒ– prompt
- âš ï¸ æ‰¹å¤„ç†å»¶è¿Ÿå¤ªé•¿ â†’ å¯ä»¥è°ƒæ•´é¢‘ç‡
- âš ï¸ API æˆæœ¬è¶…é¢„ç®— â†’ é™çº§åˆ°çº¯ Arrow

**å…³é”®**: æ¯ä¸ªé£é™©éƒ½å¯ä»¥ç‹¬ç«‹è§£å†³ï¼Œä¸å½±å“å…¶ä»–éƒ¨åˆ†

**é˜¶æ®µ 2 é£é™©ï¼ˆDï¼‰**:
- âš ï¸ è·¯ç”±å†³ç­–ä¸å‡†ç¡® â†’ è°ƒæ•´å†³ç­–æ ‘
- âš ï¸ çŸ­æ–‡æœ¬ç­–ç•¥æ•ˆæœä¸å¥½ â†’ å›é€€åˆ°ç­–ç•¥ C

**å…³é”®**: å¯ä»¥**æ¸è¿›å¼å›æ»š**
```python
# å‘ç°é—®é¢˜ï¼Ÿç«‹å³å›æ»šè·¯ç”±
router.disable_smart_routing()  # å…¨éƒ¨èµ°ç­–ç•¥ C

# æˆ–éƒ¨åˆ†å›æ»š
router.disable_strategy("arrow_only")  # åªç¦ç”¨è¿™ä¸ª
```

**æœ€åæƒ…å†µ**: å›åˆ°ç­–ç•¥ Cï¼Œ**æ•°æ®é›¶æŸå¤±**

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½ âš ï¸ **é«˜é£é™©**

**é£é™©è€¦åˆ**:

å¦‚æœå‘ç°é—®é¢˜ï¼š
```
Week 7: "è¯­ä¹‰ç´¢å¼• + çŸ­æ–‡æœ¬è·¯ç”± + å¼•ç”¨å»é‡ åŒæ—¶å‡ºé—®é¢˜"
       â†“
é—®é¢˜ 1: å“ªä¸ªç­–ç•¥å¯¼è‡´çš„ï¼Ÿ
é—®é¢˜ 2: å¦‚ä½•å•ç‹¬ç¦ç”¨ä¸€ä¸ªç­–ç•¥ï¼Ÿ
é—®é¢˜ 3: å·²å­˜å‚¨çš„æ•°æ®æ€ä¹ˆåŠï¼Ÿ
```

**å›æ»šå›°éš¾**:
```python
# æƒ³ç¦ç”¨æ™ºèƒ½è·¯ç”±ï¼Ÿ
# ä½†ä»£ç å·²ç»æ·±åº¦è€¦åˆ...
def store(self, text):
    strategy = self.router.select(text)  # åˆ°å¤„éƒ½æ˜¯
    if strategy == "arrow_only":
        ...  # é€»è¾‘åˆ†æ•£
    elif strategy == "semantic":
        ...  # æ— æ³•è½»æ˜“å›æ»š
```

**æœ€åæƒ…å†µ**: éœ€è¦**é‡æ„ä»£ç ** + **è¿ç§»æ•°æ®**

---

### 5. è¿­ä»£é€Ÿåº¦

#### æ–¹æ¡ˆ 1: å…ˆ C å D âœ… **å¿«é€Ÿè¿­ä»£**

**æ—¶é—´çº¿å¯¹æ¯”**:

```
Week 1-2: å®ç°æ ¸å¿ƒå­˜å‚¨ï¼ˆCï¼‰
Week 3:   å‘ç°é—®é¢˜ â†’ ç«‹å³ä¿®å¤
Week 4:   ä¼˜åŒ–æ€§èƒ½
Week 5-6: ç”Ÿäº§éƒ¨ç½² âœ… å¯ç”¨

[ç¨³å®šè¿è¡Œï¼Œæ”¶é›†åé¦ˆ]

Week 10+: è§¦å‘æ¡ä»¶æ»¡è¶³ â†’ å¢åŠ  D
Week 11:  å®ç°è·¯ç”±é€»è¾‘
Week 12:  ç°åº¦æµ‹è¯• âœ… å‡çº§å®Œæˆ
```

**ä¼˜åŠ¿**:
- âœ… **å¿«é€Ÿä¸Šçº¿** - Week 6 å°±å¯ç”¨
- âœ… **çœŸå®åé¦ˆ** - åŸºäºå®é™…ä½¿ç”¨æ•°æ®ä¼˜åŒ–
- âœ… **æŒ‰éœ€æŠ•å…¥** - å¯èƒ½æ°¸è¿œä¸éœ€è¦ D

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½ âš ï¸ **è¿­ä»£æ…¢**

```
Week 1-3:  å®ç°æ‰€æœ‰ç­–ç•¥
Week 4-5:  è°ƒè¯•ç»„åˆé—®é¢˜
Week 6-7:  ä¿®å¤æµ‹è¯•å¤±è´¥
Week 8-9:  æ€§èƒ½ä¼˜åŒ–
Week 10:   ç”Ÿäº§éƒ¨ç½² âœ… å¯ç”¨ï¼ˆå»¶è¿Ÿ 4 å‘¨ï¼‰

[å‘ç°å¾ˆå¤šç­–ç•¥ç”¨ä¸ä¸Š...]
```

**é—®é¢˜**:
- âŒ **å»¶è¿Ÿä¸Šçº¿** - å¤šç­‰ 4 å‘¨
- âŒ **è¿‡åº¦è®¾è®¡** - å¯èƒ½ 80% çš„åŠŸèƒ½ç”¨ä¸ä¸Š
- âŒ **æœºä¼šæˆæœ¬** - 4 å‘¨å¯ä»¥åšå…¶ä»–åŠŸèƒ½

---

### 6. æˆæœ¬å¯¹æ¯”

#### æ–¹æ¡ˆ 1: å…ˆ C å D âœ… **æˆæœ¬æ›´ä½**

**å¼€å‘æˆæœ¬**:
```
é˜¶æ®µ 1 (C): 6 å‘¨ Ã— 1 äºº = 6 äººå‘¨
é˜¶æ®µ 2 (D): 3 å‘¨ Ã— 1 äºº = 3 äººå‘¨ï¼ˆå¤ç”¨ C çš„ä»£ç ï¼‰
æ€»è®¡: 9 äººå‘¨

å¦‚æœä¸éœ€è¦ D: ä»… 6 äººå‘¨ï¼ˆèŠ‚çœ 33%ï¼‰
```

**ç»´æŠ¤æˆæœ¬**:
```
C é˜¶æ®µ: ç®€å•æ¶æ„ï¼Œ1 äººå¯ç»´æŠ¤
D é˜¶æ®µ: å¤æ‚ä¸€ç‚¹ï¼Œä½†æ¨¡å—ç‹¬ç«‹

å¹´åº¦ç»´æŠ¤: ~1 äººæœˆ/å¹´
```

**è¯•é”™æˆæœ¬**:
```
å‘ç° D ä¸éœ€è¦: æˆæœ¬ = 0ï¼ˆä¸å®æ–½ï¼‰
å‘ç° D æœ‰é—®é¢˜: å¯ä»¥å›æ»šåˆ° Cï¼ˆé›¶æŸå¤±ï¼‰
```

---

#### æ–¹æ¡ˆ 2: C+D ä¸€æ­¥åˆ°ä½ âš ï¸ **æˆæœ¬æ›´é«˜**

**å¼€å‘æˆæœ¬**:
```
ä¸€æ¬¡æ€§å®ç°: 10 å‘¨ Ã— 1 äºº = 10 äººå‘¨
ï¼ˆéœ€è¦å¤„ç†å¤æ‚äº¤äº’ï¼Œä¸èƒ½ç®€å•ç´¯åŠ ï¼‰

å¼ºåˆ¶æŠ•å…¥: æ— æ³•èŠ‚çœ
```

**ç»´æŠ¤æˆæœ¬**:
```
å¤æ‚æ¶æ„: éœ€è¦ 1.5 äººç»´æŠ¤
å¹´åº¦ç»´æŠ¤: ~2 äººæœˆ/å¹´
```

**è¯•é”™æˆæœ¬**:
```
å‘ç°è®¾è®¡é—®é¢˜: éœ€è¦é‡æ„ï¼ˆ3-5 å‘¨ï¼‰
å‘ç°ç­–ç•¥æ— ç”¨: å·²æŠ•å…¥æˆæœ¬ï¼ˆæ— æ³•æ”¶å›ï¼‰
```

---

## æ¶æ„å…¼å®¹æ€§åˆ†æ â­ å…³é”®ç‚¹

### ä¸ºä»€ä¹ˆ C â†’ D é›¶è¿ç§»æˆæœ¬ï¼Ÿ

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**: **æ•°æ®ä¸ç­–ç•¥åˆ†ç¦»**

```python
# æ•°æ®å±‚ï¼ˆä¸å˜ï¼‰
@dataclass
class StoredMemory:
    id: str
    original_compressed: bytes  # åŸæ–‡ï¼ˆArrowï¼‰
    semantic_index: Optional[SemanticIndex]  # ç´¢å¼•ï¼ˆå¯é€‰ï¼‰
    embedding: np.ndarray  # å‘é‡
    metadata: dict  # â† çµæ´»æ‰©å±•ç‚¹

# ç­–ç•¥å±‚ï¼ˆå¯æ¼”è¿›ï¼‰
class CompressionStrategy(ABC):
    def store(self, memory: StoredMemory) -> None: ...
    def retrieve(self, id: str) -> StoredMemory: ...

# C é˜¶æ®µï¼šå•ä¸€ç­–ç•¥
strategies = [SemanticIndexStrategy()]

# D é˜¶æ®µï¼šå¤šç­–ç•¥ï¼ˆå‘åå…¼å®¹ï¼‰
strategies = [
    ArrowOnlyStrategy(),      # æ–°å¢
    SemanticIndexStrategy(),  # å¤ç”¨ C
    LLMRealtimeStrategy(),   # æ–°å¢
    ReferenceStrategy()      # æ–°å¢
]
```

**æ£€ç´¢æ—¶è‡ªåŠ¨é€‚é…**:
```python
def retrieve(self, id: str) -> Memory:
    stored = storage.load(id)

    # æ ¹æ® metadata è‡ªåŠ¨é€‰æ‹©ç­–ç•¥
    strategy_name = stored.metadata.get("strategy", "semantic_index")
    strategy = self.get_strategy(strategy_name)

    return strategy.retrieve(stored)

# C é˜¶æ®µçš„æ•°æ® â†’ è‡ªåŠ¨ç”¨ SemanticIndexStrategy
# D é˜¶æ®µçš„æ•°æ® â†’ æ ¹æ® metadata é€‰æ‹©å¯¹åº”ç­–ç•¥
```

**å…¼å®¹æ€§éªŒè¯**:
```python
def test_c_to_d_compatibility():
    # 1. C é˜¶æ®µå­˜å‚¨æ•°æ®
    store_v1 = MemoryStoreV1()  # ç­–ç•¥ C
    id_old = store_v1.store("test text")

    # 2. å‡çº§åˆ° D
    store_v2 = MemoryStoreV2()  # ç­–ç•¥ C+D

    # 3. è¯»å–æ—§æ•°æ®
    memory = store_v2.retrieve(id_old)
    assert memory.text == "test text"  # âœ… å®Œå…¨å…¼å®¹

    # 4. æ–°æ•°æ®ä½¿ç”¨æ–°ç­–ç•¥
    id_new = store_v2.store("hi")  # è‡ªåŠ¨è·¯ç”±åˆ° arrow_only

    # 5. æ··åˆæ£€ç´¢
    results = store_v2.search("test")
    assert id_old in results  # âœ… æ—§æ•°æ®å¯æ£€ç´¢
    assert id_new in results  # âœ… æ–°æ•°æ®å¯æ£€ç´¢
```

---

## å†³ç­–å»ºè®®

### âœ… æ¨èï¼šå…ˆ C å Dï¼ˆæ¸è¿›å¼æ¼”è¿›ï¼‰

**ç†ç”±æ€»ç»“**:

| ç»´åº¦ | å…ˆ C å D | C+D ä¸€æ­¥åˆ°ä½ | ä¼˜åŠ¿ |
|-----|----------|-------------|------|
| **å¼€å‘å¤æ‚åº¦** | 800 + 400 = 1,200 LOC | 1,500 LOC (éš¾åº¦ 2x) | âœ… C æ›´ç®€å• |
| **æ•°æ®è¿ç§»** | é›¶æˆæœ¬ | å¯èƒ½éœ€è¦è¿ç§» | âœ… C é›¶è¿ç§» |
| **æµ‹è¯•å¤æ‚åº¦** | 50 + 30 = 80 ç”¨ä¾‹ | 100+ ç”¨ä¾‹ | âœ… C æ›´å°‘ |
| **é£é™©æ§åˆ¶** | åˆ†é˜¶æ®µï¼Œå¯å›æ»š | è€¦åˆï¼Œéš¾å›æ»š | âœ… C ä½é£é™© |
| **ä¸Šçº¿æ—¶é—´** | Week 6 | Week 10 | âœ… C å¿« 4 å‘¨ |
| **å¼€å‘æˆæœ¬** | 6-9 äººå‘¨ | 10+ äººå‘¨ | âœ… C çœ 10-30% |
| **ç»´æŠ¤æˆæœ¬** | 1 äººæœˆ/å¹´ | 2 äººæœˆ/å¹´ | âœ… C çœ 50% |
| **çµæ´»æ€§** | å¯ä»¥ä¸åš D | å¼ºåˆ¶æŠ•å…¥ | âœ… C çµæ´» |

---

### å®æ–½å»ºè®®

**é˜¶æ®µ 1: ç­–ç•¥ Cï¼ˆç«‹å³å¼€å§‹ï¼‰**

```
Week 1-2: æ ¸å¿ƒå­˜å‚¨ + æ£€ç´¢
Week 3-4: è¯­ä¹‰ç´¢å¼•é›†æˆ
Week 5-6: ä¼˜åŒ– + éƒ¨ç½²

âœ… Checkpoint: ç³»ç»Ÿå¯ç”¨ï¼Œå¼€å§‹æ”¶é›†æ•°æ®
```

**é˜¶æ®µ 1.5: è§‚å¯ŸæœŸï¼ˆ3-6 ä¸ªæœˆï¼‰**

```
æ”¶é›†æŒ‡æ ‡:
- æ—¥å‡ API æˆæœ¬
- æ–‡æœ¬é•¿åº¦åˆ†å¸ƒ
- é‡å¤è¯­ä¹‰æ¯”ä¾‹
- å¤šæ¨¡æ€å†…å®¹æ¯”ä¾‹

è¯„ä¼°: æ˜¯å¦éœ€è¦ç­–ç•¥ Dï¼Ÿ
```

**é˜¶æ®µ 2: ç­–ç•¥ Dï¼ˆè§¦å‘æ¡ä»¶æ»¡è¶³æ—¶ï¼‰**

**è§¦å‘æ¡ä»¶**ï¼ˆæ»¡è¶³ä»»ä¸€å³å¯ï¼‰:
```
1. æ—¥å‡ API æˆæœ¬ > $5
2. çŸ­æ–‡æœ¬ (<100 å­—ç¬¦) å æ¯” > 50%
3. é‡å¤è¯­ä¹‰æ£€æµ‹åˆ° > 20% é‡å¤ç‡
4. å¤šæ¨¡æ€å†…å®¹ > 10%
```

**å®æ–½**:
```
Week 1: å®ç°æ™ºèƒ½è·¯ç”±å™¨
Week 2: ç°åº¦æµ‹è¯•ï¼ˆ10% æµé‡ï¼‰
Week 3: å…¨é‡ä¸Šçº¿

âœ… Checkpoint: æˆæœ¬é™ä½ï¼Œæ€§èƒ½æå‡
```

---

## é™„å½•ï¼šè¿ç§»è„šæœ¬ç¤ºä¾‹

è™½ç„¶ C â†’ D **ä¸éœ€è¦è¿ç§»**ï¼Œä½†ä¸ºäº†æ¼”ç¤ºå…¼å®¹æ€§ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ª"æ ‡è®°æ—§æ•°æ®"çš„è„šæœ¬ï¼š

```python
def mark_legacy_data():
    """
    å¯é€‰ï¼šä¸º C é˜¶æ®µæ•°æ®æ·»åŠ ç­–ç•¥æ ‡è®°
    ï¼ˆä¸æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºä»£ç ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
    """

    # æŸ¥æ‰¾æ‰€æœ‰æ²¡æœ‰ strategy å­—æ®µçš„è®°å¿†
    old_memories = storage.find({
        "metadata.strategy": {"$exists": False}
    })

    for memory in old_memories:
        # æ·»åŠ ç­–ç•¥æ ‡è®°
        memory.metadata["strategy"] = "semantic_index"
        memory.metadata["migrated_from"] = "phase_c"
        memory.metadata["migration_date"] = datetime.now()

        # æ›´æ–°å­˜å‚¨
        storage.update(memory)

    print(f"Marked {len(old_memories)} legacy memories")
    # ä½†å³ä½¿ä¸è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼
```

---

## æ€»ç»“

**æœ€ç»ˆå»ºè®®**: âœ… **å…ˆå®æ–½ç­–ç•¥ Cï¼ŒæŒ‰éœ€æ¼”è¿›åˆ°ç­–ç•¥ D**

**æ ¸å¿ƒåŸå› **:
1. **é›¶è¿ç§»æˆæœ¬** - æ•°æ®ç»“æ„å®Œå…¨å…¼å®¹
2. **ä½å¼€å‘æˆæœ¬** - èŠ‚çœ 10-30% äººåŠ›
3. **å¿«é€Ÿä¸Šçº¿** - æå‰ 4 å‘¨å¯ç”¨
4. **ä½é£é™©** - åˆ†é˜¶æ®µéªŒè¯ï¼Œå¯å›æ»š
5. **é«˜çµæ´»æ€§** - å¯èƒ½æ°¸è¿œä¸éœ€è¦ D

**å…³é”®è®¾è®¡**:
```python
# ä»ä¸€å¼€å§‹å°±è®¾è®¡å…¼å®¹æ€§
@dataclass
class StoredMemory:
    metadata: dict  # â† çµæ´»æ‰©å±•ç‚¹ï¼Œé›¶æˆæœ¬æ¼”è¿›
```

è¿™å°±æ˜¯**ä¼˜ç§€æ¶æ„è®¾è®¡**çš„ä½“ç°ï¼š**ä¸ºæ¼”è¿›è€Œè®¾è®¡ï¼Œä½†ä¸è¿‡åº¦è®¾è®¡**ã€‚

---

**æ–‡æ¡£ä½œè€…**: Claude Code
**æœ€åæ›´æ–°**: 2026-02-17
