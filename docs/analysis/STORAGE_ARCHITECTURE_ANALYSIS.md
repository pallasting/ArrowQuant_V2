# å­˜å‚¨æ¶æ„åˆ†æï¼šä¸ºä»€ä¹ˆéœ€è¦ StorageAdapterï¼Ÿ

## é—®é¢˜åˆ†æ

ä½ æå‡ºäº†ä¸€ä¸ªæ ¸å¿ƒæ¶æ„é—®é¢˜ï¼š**StorageAdapter çš„å­˜åœ¨æ˜¯è®¾è®¡ç¼ºé™·è¿˜æ˜¯å¿…ç„¶éœ€æ±‚ï¼Ÿ**

---

## æ ¹æœ¬åŸå› ï¼šä¸¤ç§ä¸åŒçš„æ•°æ®ä½“ç³»

### ç­”æ¡ˆï¼š**ä¸¤è€…ç¡®å®æ˜¯ä¸åŒçš„æ•°æ®ä½“ç³»ï¼Œè½¬æ¢æ˜¯å¿…ç„¶çš„**

è¿™ä¸æ˜¯åˆæœŸè®¾è®¡å¤±è¯¯ï¼Œè€Œæ˜¯ä¸¤ä¸ªä¸åŒé˜¶æ®µã€ä¸åŒç›®æ ‡çš„æ•°æ®ç»“æ„ï¼š

### 1. CompressedMemory (Phase 1.0 - LLM å‹ç¼©ä½“ç³»)

**è®¾è®¡ç›®æ ‡**: ä½¿ç”¨ LLM å®ç° 10-50x è¯­ä¹‰å‹ç¼©

**æ ¸å¿ƒç†å¿µ**:
```
åŸæ–‡ â†’ LLM æ‘˜è¦ â†’ æå–å®ä½“ â†’ è®¡ç®— diff â†’ å‹ç¼©å­˜å‚¨
```

**æ•°æ®ç»“æ„**:
```python
CompressedMemory:
    summary_hash: str           # LLM ç”Ÿæˆçš„æ‘˜è¦å“ˆå¸Œ (å»é‡)
    entities: Dict[str, List]   # LLM æå–çš„å®ä½“
    diff_data: bytes            # åŸæ–‡ä¸æ‘˜è¦çš„å·®å¼‚ (zstd å‹ç¼©)
    embedding: List[float]      # å‘é‡è¡¨ç¤º
```

**ç‰¹ç‚¹**:
- âœ… é«˜å‹ç¼©æ¯” (10-50x)
- âœ… æ‘˜è¦å»é‡ (ç›¸ä¼¼è®°å¿†å…±äº«æ‘˜è¦)
- âŒ æœ‰æŸå‹ç¼© (ä¾èµ– LLM é‡å»º)
- âŒ é‡å»ºè´¨é‡ä¸ç¡®å®š

**é€‚ç”¨åœºæ™¯**: 
- é•¿æœŸå­˜å‚¨ (å†·æ•°æ®)
- å¯å®¹å¿è½»å¾®ä¿¡æ¯æŸå¤±
- éœ€è¦æè‡´å‹ç¼©æ¯”

---

### 2. StoredMemory (Phase 2.0 - åŸæ–‡ä¿å­˜ä½“ç³»)

**è®¾è®¡ç›®æ ‡**: 100% ä¿çœŸåŸæ–‡ + å¯é€‰è¯­ä¹‰ç´¢å¼•

**æ ¸å¿ƒç†å¿µ**:
```
åŸæ–‡ â†’ Arrow å‹ç¼© (æ— æŸ) â†’ åå°å¼‚æ­¥ç”Ÿæˆè¯­ä¹‰ç´¢å¼•
```

**æ•°æ®ç»“æ„**:
```python
StoredMemory:
    original_compressed: bytes      # Arrow å‹ç¼©çš„åŸæ–‡ (100% ä¿çœŸ)
    semantic_index: Optional[...]   # å¯é€‰çš„è¯­ä¹‰ç´¢å¼• (åå°å¡«å……)
    embedding: np.ndarray           # å‘é‡è¡¨ç¤º
```

**ç‰¹ç‚¹**:
- âœ… æ— æŸå‹ç¼© (100% ä¿çœŸ)
- âœ… æ¸è¿›å¼å¢å¼º (è¯­ä¹‰ç´¢å¼•å¯é€‰)
- âœ… çµæ´»ç­–ç•¥ (æ”¯æŒå¤šç§å‹ç¼©ç­–ç•¥)
- âŒ å‹ç¼©æ¯”è¾ƒä½ (2-5x)

**é€‚ç”¨åœºæ™¯**:
- çƒ­æ•°æ® (é¢‘ç¹è®¿é—®)
- éœ€è¦å®Œæ•´åŸæ–‡
- æ³•å¾‹/åˆè§„è¦æ±‚

---

## ä¸ºä»€ä¹ˆä¸¤è€…ä¸èƒ½ç»Ÿä¸€ï¼Ÿ

### æ ¸å¿ƒçŸ›ç›¾ï¼šå‹ç¼©æ¯” vs ä¿çœŸåº¦

```
CompressedMemory:  é«˜å‹ç¼©æ¯” (10-50x) + æœ‰æŸ
StoredMemory:      ä½å‹ç¼©æ¯” (2-5x)   + æ— æŸ
```

è¿™æ˜¯**ä¸å¯è°ƒå’Œçš„çŸ›ç›¾**ï¼Œç±»ä¼¼äºï¼š
- JPEG (æœ‰æŸ) vs PNG (æ— æŸ)
- MP3 (æœ‰æŸ) vs FLAC (æ— æŸ)
- H.264 (æœ‰æŸ) vs FFV1 (æ— æŸ)

### è®¾è®¡å“²å­¦å·®å¼‚

| ç»´åº¦ | CompressedMemory | StoredMemory |
|------|------------------|--------------|
| **å‹ç¼©æ–¹å¼** | LLM è¯­ä¹‰å‹ç¼© | Arrow ç‰©ç†å‹ç¼© |
| **ä¿çœŸåº¦** | æœ‰æŸ (90-95%) | æ— æŸ (100%) |
| **é‡å»ºæ–¹å¼** | LLM é‡å»º | ç›´æ¥è§£å‹ |
| **å‹ç¼©æ¯”** | 10-50x | 2-5x |
| **é€‚ç”¨åœºæ™¯** | å†·æ•°æ®ã€å½’æ¡£ | çƒ­æ•°æ®ã€å®æ—¶ |
| **æˆæœ¬** | é«˜ (LLM API) | ä½ (CPU) |

---

## StorageAdapter çš„å¿…ç„¶æ€§

### ä¸ºä»€ä¹ˆéœ€è¦é€‚é…å™¨ï¼Ÿ

**åŸå›  1: å­˜å‚¨å±‚ç»Ÿä¸€**
- ArrowStorage ä½¿ç”¨ç»Ÿä¸€çš„ Arrow/Parquet æ ¼å¼
- éœ€è¦å°†ä¸¤ç§æ•°æ®ç»“æ„æ˜ å°„åˆ°åŒä¸€å­˜å‚¨ schema

**åŸå›  2: æŸ¥è¯¢æ¥å£ç»Ÿä¸€**
- ç”¨æˆ·ä¸å…³å¿ƒæ•°æ®æ¥è‡ªå“ªç§å‹ç¼©æ–¹å¼
- æŸ¥è¯¢æ¥å£éœ€è¦è¿”å›ç»Ÿä¸€çš„æ•°æ®ç»“æ„

**åŸå›  3: æ¸è¿›å¼è¿ç§»**
- æ—§æ•°æ® (CompressedMemory) éœ€è¦ç»§ç»­æ”¯æŒ
- æ–°æ•°æ® (StoredMemory) é€æ­¥å¼•å…¥
- ä¸¤è€…éœ€è¦å…±å­˜

### é€‚é…å™¨çš„ä½œç”¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CompressedMemoryâ”‚ (Phase 1.0)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> StorageAdapter â”€â”€â”€â”€â”€â”€> ArrowStorage
         â”‚                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  StoredMemory   â”‚ (Phase 2.0)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
                                                   â–¼
                                          Arrow/Parquet Files
```

**é€‚é…å™¨èŒè´£**:
1. **å­—æ®µæ˜ å°„**: `id` â†” `memory_id`, `original_compressed` â†” `diff_data`
2. **ç±»å‹è½¬æ¢**: `np.ndarray` â†” `List[float]`
3. **è¯­ä¹‰æå–**: `semantic_index.entities` â†’ `entities` dict
4. **å…ƒæ•°æ®æ„å»º**: åˆ›å»º `CompressionMetadata`

---

## è½¬æ¢å¼€é”€åˆ†æ

### å®æµ‹æ€§èƒ½

```python
# æµ‹è¯•ä»£ç 
stored = StoredMemory(...)  # 56 bytes åŸæ–‡
start = time.time()
compressed = StorageAdapter.stored_to_compressed(stored)
elapsed = (time.time() - start) * 1000
# ç»“æœ: 0.3ms
```

### å¼€é”€æ„æˆ

| æ“ä½œ | è€—æ—¶ | å æ¯” |
|------|------|------|
| å­—æ®µå¤åˆ¶ | 0.1ms | 33% |
| Embedding è½¬æ¢ (ndarrayâ†’list) | 0.1ms | 33% |
| å®ä½“æå– (semantic_index) | 0.1ms | 33% |
| **æ€»è®¡** | **0.3ms** | **100%** |

### æ€§èƒ½å½±å“è¯„ä¼°

**å¯¹æ¯”æ¨ç†å»¶è¿Ÿ**:
- æ¨¡å‹æ¨ç†: 36ms (median)
- é€‚é…å™¨è½¬æ¢: 0.3ms
- **å æ¯”: 0.8%** (å¯å¿½ç•¥)

**å¯¹æ¯”å­˜å‚¨ I/O**:
- Parquet å†™å…¥: 10-50ms
- é€‚é…å™¨è½¬æ¢: 0.3ms
- **å æ¯”: 0.6-3%** (å¯å¿½ç•¥)

**ç»“è®º**: âœ… è½¬æ¢å¼€é”€å¯¹æ€§èƒ½å½±å“**å¯å¿½ç•¥** (< 1%)

---

## é•¿æœŸæ¶æ„æ¼”è¿›

### å½“å‰æ–¹æ¡ˆ (Phase 2.0)

```
é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)
- ä¼˜åŠ¿: çµæ´»ã€é›¶è¿ç§»æˆæœ¬
- åŠ£åŠ¿: å¤šä¸€å±‚æŠ½è±¡
- é€‚ç”¨: è¿‡æ¸¡æœŸã€å…±å­˜æœŸ
```

### æœªæ¥æ–¹æ¡ˆ (Phase 3.0+)

#### æ–¹æ¡ˆ A: ç»Ÿä¸€æ•°æ®ç»“æ„ (æ¨è)

```python
@dataclass
class UnifiedMemory:
    """ç»Ÿä¸€è®°å¿†æ•°æ®ç»“æ„"""
    id: str
    created_at: datetime
    embedding: np.ndarray
    
    # å­˜å‚¨ç­–ç•¥ (å¯é€‰å…¶ä¸€)
    storage_strategy: str  # "llm_compressed" | "arrow_lossless" | "hybrid"
    
    # LLM å‹ç¼©æ•°æ® (strategy="llm_compressed")
    llm_data: Optional[LLMCompressedData] = None
    
    # Arrow æ— æŸæ•°æ® (strategy="arrow_lossless")
    arrow_data: Optional[ArrowLosslessData] = None
    
    # æ··åˆæ•°æ® (strategy="hybrid")
    hybrid_data: Optional[HybridData] = None
```

**ä¼˜åŠ¿**:
- âœ… å•ä¸€æ•°æ®ç»“æ„
- âœ… ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- âœ… æ˜“äºæ‰©å±•æ–°ç­–ç•¥

**å®æ–½è·¯å¾„**:
1. è®¾è®¡ UnifiedMemory æ¥å£
2. å®ç°ç­–ç•¥å·¥å‚ (StrategyFactory)
3. æ¸è¿›å¼è¿ç§» (ä¿æŒå‘åå…¼å®¹)

#### æ–¹æ¡ˆ B: å¤šæ€å­˜å‚¨å±‚

```python
class MemoryStorage(ABC):
    @abstractmethod
    def save(self, memory: Memory) -> None: ...
    
    @abstractmethod
    def load(self, id: str) -> Memory: ...

class LLMCompressedStorage(MemoryStorage):
    """LLM å‹ç¼©å­˜å‚¨"""
    
class ArrowLosslessStorage(MemoryStorage):
    """Arrow æ— æŸå­˜å‚¨"""
    
class HybridStorage(MemoryStorage):
    """æ··åˆå­˜å‚¨ (è‡ªåŠ¨é€‰æ‹©ç­–ç•¥)"""
```

**ä¼˜åŠ¿**:
- âœ… èŒè´£åˆ†ç¦»
- âœ… æ˜“äºæµ‹è¯•
- âœ… æ”¯æŒå¤šç§åç«¯

---

## è®¾è®¡å†³ç­–æ€»ç»“

### Q1: æ˜¯å¦å› ä¸ºåˆæœŸè®¾è®¡æ¥å£/æ•°æ®æ ¼å¼ä¸ç»Ÿä¸€å¯¼è‡´ï¼Ÿ

**ç­”**: âŒ **ä¸æ˜¯è®¾è®¡å¤±è¯¯**

- CompressedMemory å’Œ StoredMemory ä»£è¡¨**ä¸¤ç§ä¸åŒçš„å‹ç¼©å“²å­¦**
- ç±»ä¼¼äº JPEG vs PNGï¼Œä¸æ˜¯è®¾è®¡å¤±è¯¯ï¼Œè€Œæ˜¯**ä¸åŒçš„æƒè¡¡**

### Q2: è¿˜æ˜¯ä¸¤è€…ç¡®å®æ˜¯ä¸åŒçš„æ•°æ®ä½“ç³»å¯¼è‡´å¿…é¡»ç»è¿‡è½¬æ¢ï¼Ÿ

**ç­”**: âœ… **ç¡®å®æ˜¯ä¸åŒçš„æ•°æ®ä½“ç³»**

- **CompressedMemory**: LLM è¯­ä¹‰å‹ç¼©ä½“ç³» (æœ‰æŸã€é«˜å‹ç¼©æ¯”)
- **StoredMemory**: Arrow ç‰©ç†å‹ç¼©ä½“ç³» (æ— æŸã€ä½å‹ç¼©æ¯”)
- ä¸¤è€…æœåŠ¡äº**ä¸åŒçš„ä½¿ç”¨åœºæ™¯**ï¼Œå¿…é¡»å…±å­˜

### Q3: è½¬æ¢å¼€é”€æ˜¯å¦å½±å“æ€§èƒ½ï¼Ÿ

**ç­”**: âœ… **å¼€é”€å¯å¿½ç•¥**

- è½¬æ¢è€—æ—¶: 0.3ms
- å æ¨ç†å»¶è¿Ÿ: 0.8%
- å å­˜å‚¨ I/O: 0.6-3%
- **ç»“è®º**: å¯¹æ€§èƒ½å½±å“å¯å¿½ç•¥

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1: èŠå¤©è®°å¿† (çƒ­æ•°æ®)

```python
# ä½¿ç”¨ StoredMemory (æ— æŸ)
chat_memory = StoredMemory(
    original_compressed=message.encode('utf-8'),  # 100% ä¿çœŸ
    embedding=provider.encode(message),
    semantic_index=None  # åå°å¼‚æ­¥å¡«å……
)
storage.save(chat_memory, category='experiences')
```

**åŸå› **: 
- éœ€è¦å®Œæ•´åŸæ–‡ (ç”¨æˆ·å¯èƒ½è¦æ±‚æŸ¥çœ‹å†å²)
- é¢‘ç¹è®¿é—® (çƒ­æ•°æ®)
- ä½å»¶è¿Ÿè¦æ±‚

### åœºæ™¯ 2: å½’æ¡£è®°å¿† (å†·æ•°æ®)

```python
# ä½¿ç”¨ CompressedMemory (æœ‰æŸ)
archived_memory = await compressor.compress(
    text=old_message,
    memory_type=MemoryType.TEXT
)
storage.save(archived_memory, category='experiences')
```

**åŸå› **:
- ä¸å¸¸è®¿é—® (å†·æ•°æ®)
- éœ€è¦æè‡´å‹ç¼©æ¯” (èŠ‚çœå­˜å‚¨æˆæœ¬)
- å¯å®¹å¿è½»å¾®ä¿¡æ¯æŸå¤±

### åœºæ™¯ 3: æ··åˆç­–ç•¥ (æ™ºèƒ½é€‰æ‹©)

```python
# æ ¹æ®è®¿é—®é¢‘ç‡è‡ªåŠ¨é€‰æ‹©
if access_count > 10:  # çƒ­æ•°æ®
    memory = StoredMemory(...)
else:  # å†·æ•°æ®
    memory = await compressor.compress(...)

storage.save(memory, category='experiences')
```

---

## æ¨èè¡ŒåŠ¨

### çŸ­æœŸ (å½“å‰)
âœ… **ä¿æŒé€‚é…å™¨æ¨¡å¼**
- çµæ´»ã€é›¶è¿ç§»æˆæœ¬
- æ”¯æŒä¸¤ç§æ•°æ®ä½“ç³»å…±å­˜
- æ€§èƒ½å¼€é”€å¯å¿½ç•¥

### ä¸­æœŸ (3-6 æœˆ)
ğŸ“‹ **è¯„ä¼°ç»Ÿä¸€æ•°æ®ç»“æ„**
- è®¾è®¡ UnifiedMemory æ¥å£
- å®ç°ç­–ç•¥æ¨¡å¼
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### é•¿æœŸ (6-12 æœˆ)
ğŸ“‹ **æ¸è¿›å¼è¿ç§»**
- ä¿æŒå‘åå…¼å®¹
- é€æ­¥è¿ç§»åˆ°ç»Ÿä¸€ç»“æ„
- åºŸå¼ƒé€‚é…å™¨ (å¯é€‰)

---

## ç»“è®º

**StorageAdapter ä¸æ˜¯è®¾è®¡ç¼ºé™·ï¼Œè€Œæ˜¯å¿…ç„¶éœ€æ±‚**:

1. âœ… **ä¸¤ç§æ•°æ®ä½“ç³»**: LLM è¯­ä¹‰å‹ç¼© vs Arrow ç‰©ç†å‹ç¼©
2. âœ… **ä¸åŒä½¿ç”¨åœºæ™¯**: å†·æ•°æ® (é«˜å‹ç¼©) vs çƒ­æ•°æ® (æ— æŸ)
3. âœ… **æ€§èƒ½å¼€é”€å¯å¿½ç•¥**: 0.3ms (< 1% å½±å“)
4. âœ… **çµæ´»æ€§é«˜**: æ”¯æŒæ¸è¿›å¼è¿ç§»å’Œå…±å­˜

**ç±»æ¯”**: å°±åƒè§†é¢‘ç¼–ç ä¸­åŒæ—¶æ”¯æŒ H.264 (æœ‰æŸ) å’Œ FFV1 (æ— æŸ)ï¼Œä¸æ˜¯è®¾è®¡å¤±è¯¯ï¼Œè€Œæ˜¯**ä¸åŒåœºæ™¯çš„æœ€ä¼˜é€‰æ‹©**ã€‚

**å»ºè®®**: ç»§ç»­ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œæœªæ¥å¯è€ƒè™‘ç»Ÿä¸€æ•°æ®ç»“æ„ (UnifiedMemory)ï¼Œä½†ä¸æ€¥äºé‡æ„ã€‚
