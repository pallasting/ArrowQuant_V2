# AngelSlim 集成实施任务清单

## 状态说明
- [ ] 未开始
- [🔄] 进行中
- [✅] 已完成
- [⏸️] 暂停/阻塞

## Phase 1: 环境搭建和基础集成（Week 1-2）

### 1.1 依赖管理
- [✅] 调研 AngelSlim 安装方式
- [ ] 更新 setup.py 添加可选依赖
- [ ] 创建 requirements-angelslim.txt
- [ ] 测试安装流程
- [ ] 文档化安装步骤

### 1.2 模型格式转换器
- [✅] 设计转换器接口
  - [✅] ParquetToHuggingFace 转换器（占位符）
  - [✅] HuggingFaceToParquet 转换器
- [ ] 实现 Parquet → HuggingFace
  - [ ] 读取 Parquet V1/V2 格式
  - [ ] 构建 HuggingFace 模型结构
  - [ ] 加载权重到 HuggingFace 模型
  - [ ] 保存为 HuggingFace 格式
- [✅] 实现 HuggingFace → Parquet
  - [✅] 加载 HuggingFace 模型
  - [✅] 提取权重和元数据
  - [✅] 转换为 Parquet V1/V2 格式
  - [✅] 保存 Parquet 文件
  - [✅] 支持 BFloat16 格式
  - [✅] 自动检测量化模型
- [✅] 单元测试
  - [✅] 测试往返转换一致性
  - [✅] 测试不同模型架构
  - [✅] 测试错误处理
  - [✅] 17/17 单元测试通过
- [✅] 集成测试
  - [✅] 测试与 WeightLoader 集成
  - [✅] 测试端到端转换流程
  - [✅] 6/6 集成测试通过

### 1.3 AngelSlim 包装器
- [ ] 设计 AngelSlimQuantizer 接口
- [ ] 实现 AngelSlimQuantizer 类
  - [ ] 初始化 AngelSlim 引擎
  - [ ] FP8-Static 量化
  - [ ] FP8-Dynamic 量化
  - [ ] INT4-GPTQ 量化
  - [ ] INT4-AWQ 量化
- [ ] 错误处理和回退
  - [ ] AngelSlim 不可用时回退到 PTQ
  - [ ] 模型不支持时的错误提示
- [ ] 单元测试
  - [ ] 测试各种量化方法
  - [ ] 测试错误处理

### 1.4 配置扩展
- [ ] 扩展 QuantizationConfig
  - [ ] 添加 backend 字段
  - [ ] 添加 angelslim_method 字段
  - [ ] 添加 AngelSlim 特定配置
- [ ] 配置验证逻辑
- [ ] 单元测试

### 1.5 CLI 集成
- [ ] 扩展 quantize_cli.py
  - [ ] 添加 --backend 参数
  - [ ] 添加 --angelslim-method 参数
  - [ ] 添加 --calibration-data 参数
- [ ] 实现 AngelSlim 量化流程
  - [ ] 转换 Parquet → HuggingFace
  - [ ] 调用 AngelSlim 量化
  - [ ] 转换 HuggingFace → Parquet
- [ ] 进度报告和日志
- [ ] 集成测试

## Phase 2: 精度验证（Week 3）

### 2.1 测试数据准备
- [ ] 下载 Qwen3-0.6B 模型
- [ ] 转换为 Parquet 格式
- [ ] 准备校准数据集
  - [ ] 从 C4 采样
  - [ ] 或使用 WikiText
- [ ] 准备评估数据集
  - [ ] CEVAL 子集
  - [ ] MMLU 子集
  - [ ] GSM8K 子集

### 2.2 量化测试
- [ ] PTQ INT8 基线测试
- [ ] AngelSlim FP8-Static 测试
- [ ] AngelSlim FP8-Dynamic 测试
- [ ] AngelSlim INT4-GPTQ 测试
- [ ] AngelSlim INT4-AWQ 测试

### 2.3 精度评估
- [ ] 扩展 PrecisionValidator
  - [ ] 支持 FP8 格式
  - [ ] 支持 INT4 格式
- [ ] 运行精度验证
  - [ ] 余弦相似度测试
  - [ ] PPL 测试（如果适用）
- [ ] 生成对比报告
  - [ ] 精度对比表
  - [ ] 内存占用对比
  - [ ] 量化时间对比

### 2.4 性能基准测试
- [ ] 扩展 BenchmarkRunner
  - [ ] 支持 AngelSlim 模型
- [ ] 运行基准测试
  - [ ] 推理延迟
  - [ ] 吞吐率
  - [ ] 内存占用
- [ ] 生成性能报告

## Phase 3: 生产优化（Week 4）

### 3.1 性能优化
- [ ] 优化转换器性能
  - [ ] 批量处理
  - [ ] 并行化
  - [ ] 内存优化
- [ ] 优化量化流程
  - [ ] 减少中间文件
  - [ ] 流式处理
- [ ] 缓存优化
  - [ ] 缓存转换结果
  - [ ] 缓存校准数据

### 3.2 用户体验
- [ ] 添加进度条
  - [ ] 转换进度
  - [ ] 量化进度
  - [ ] 验证进度
- [ ] 改进日志输出
  - [ ] 结构化日志
  - [ ] 详细错误信息
- [ ] 添加 --dry-run 模式
- [ ] 添加 --compare 模式

### 3.3 错误处理
- [ ] 完善错误处理
  - [ ] 依赖缺失
  - [ ] 模型不支持
  - [ ] 内存不足
  - [ ] 磁盘空间不足
- [ ] 自动回退机制
  - [ ] AngelSlim 失败 → PTQ
  - [ ] GPU 不可用 → CPU
- [ ] 错误恢复
  - [ ] 断点续传
  - [ ] 清理临时文件

### 3.4 文档和示例
- [ ] 用户文档
  - [ ] 安装指南
  - [ ] 快速开始
  - [ ] API 参考
  - [ ] 故障排除
- [ ] 开发者文档
  - [ ] 架构设计
  - [ ] 扩展指南
  - [ ] 贡献指南
- [ ] 示例代码
  - [ ] 基础量化示例
  - [ ] 高级配置示例
  - [ ] 批量处理示例
- [ ] 教程
  - [ ] 端到端教程
  - [ ] 性能调优教程

## Phase 4: 测试和质量保证

### 4.1 单元测试
- [ ] 转换器测试
  - [ ] 往返一致性
  - [ ] 边界情况
  - [ ] 错误处理
- [ ] 量化器测试
  - [ ] 各种量化方法
  - [ ] 配置验证
  - [ ] 错误处理
- [ ] 配置测试
  - [ ] 配置加载
  - [ ] 配置验证
  - [ ] 环境变量覆盖

### 4.2 集成测试
- [ ] 端到端量化流程
  - [ ] PTQ 流程
  - [ ] AngelSlim 流程
  - [ ] 混合流程
- [ ] CLI 测试
  - [ ] 各种参数组合
  - [ ] 错误场景
  - [ ] 帮助信息
- [ ] 精度验证测试
  - [ ] 各种量化方法
  - [ ] 阈值验证

### 4.3 性能测试
- [ ] 量化性能测试
  - [ ] 不同模型大小
  - [ ] 不同量化方法
  - [ ] 不同硬件配置
- [ ] 推理性能测试
  - [ ] 延迟测试
  - [ ] 吞吐率测试
  - [ ] 内存占用测试
- [ ] 回归测试
  - [ ] 性能回归
  - [ ] 精度回归

### 4.4 代码质量
- [ ] 代码审查
  - [ ] 代码风格
  - [ ] 类型注解
  - [ ] 文档字符串
- [ ] 静态分析
  - [ ] mypy 类型检查
  - [ ] flake8 代码检查
  - [ ] black 格式化
- [ ] 测试覆盖率
  - [ ] 单元测试覆盖率 >90%
  - [ ] 集成测试覆盖率 >80%

## 当前优先级

### 立即执行（本周）
1. [🔄] 更新 setup.py 添加 AngelSlim 依赖
2. [ ] 安装 AngelSlim 并验证
3. [ ] 实现 Parquet → HuggingFace 转换器
4. [ ] 实现 HuggingFace → Parquet 转换器
5. [ ] 单元测试转换器

### 下周执行
1. [ ] 实现 AngelSlimQuantizer
2. [ ] 扩展 QuantizationConfig
3. [ ] 集成到 CLI
4. [ ] 端到端测试

### 两周后执行
1. [ ] 精度验证
2. [ ] 性能基准测试
3. [ ] 生成报告

## 阻塞问题

### 当前阻塞
- 无

### 潜在风险
1. **AngelSlim 依赖冲突**: 可能与现有依赖冲突
   - 缓解: 使用虚拟环境隔离测试
2. **模型格式复杂性**: Parquet ↔ HuggingFace 转换可能复杂
   - 缓解: 先支持简单模型（Qwen3-0.6B）
3. **校准数据准备**: 需要合适的校准数据
   - 缓解: 使用标准数据集（C4, WikiText）

## 成功标准

### Phase 1 完成标准
- [x] AngelSlim 成功安装
- [ ] 转换器单元测试通过
- [ ] AngelSlimQuantizer 单元测试通过
- [ ] CLI 集成测试通过

### Phase 2 完成标准
- [ ] Qwen3-0.6B FP8 量化成功
- [ ] 精度满足要求（>99%）
- [ ] 性能报告生成

### Phase 3 完成标准
- [ ] 用户文档完整
- [ ] 示例代码可运行
- [ ] 错误处理完善

### Phase 4 完成标准
- [ ] 测试覆盖率 >90%
- [ ] 所有测试通过
- [ ] 代码审查通过

## 时间估算

| Phase | 任务数 | 预计时间 | 实际时间 |
|-------|--------|---------|---------|
| Phase 1 | 15 | 2 周 | - |
| Phase 2 | 12 | 1 周 | - |
| Phase 3 | 12 | 1 周 | - |
| Phase 4 | 12 | 1 周 | - |
| **总计** | **51** | **5 周** | **-** |

## 下一步行动

**立即执行**:
1. 更新 setup.py
2. 安装 AngelSlim
3. 开始实现转换器

**今日目标**:
- 完成依赖管理
- 开始转换器实现
- 完成转换器接口设计

**本周目标**:
- 完成转换器实现和测试
- 开始 AngelSlimQuantizer 实现
